var perWidget=!0,called_again=!1,syncDataCalledCnt=0,tier1CityListPersonalize=["Bengaluru","Delhi","Chennai","Hyderabad","Mumbai","Pune","Kolkata","Ahmedabad"],personalizeVer=16,isSyncLSDataComplete=!1;async function initFunc(e){"undefined"!=typeof IMStore&&!0==IMStore.localStorageLoaded?syncDataCheck():e<=10?setTimeout(()=>{initFunc(e+1)},500):syncDataCheck()}async function syncDataCheck(){syncDataCalledCnt+=1;let e=0,t="",a="na",r="",n=1,i=new Date().getTime();if("undefined"!=typeof sugg&&sugg&&"function"==typeof sugg.recent){let c=await sugg.recent("meta_data")||[],l=document.cookie;l.includes("ImeshVisitor")&&l.includes("glid%3D")&&(a=getDataFromCookies(1),n=2),l.includes("im_iss=")&&!l.includes("im_iss=;")&&(t=getDataFromCookies(3),n=3),r=getDataFromCookies(2);let s=c.length>0?c[c.length-1]:null,d=s?.p_gid||"na",o=s?.p_vid||"",m=s?.m_time,u=s?.m||-1,f=i-m>6e5||d!=a||n!=u;"na"!=d&&d!=a&&(e=1);let g=!1;(n<u||1==e)&&(["prod_data","mcat_data","keyw_data"].forEach(deleteImsKey),g=!0),0===c.length||f?(sugg.recent({meta_data:[{m_time:m,p_gid:a,p_vid:r,m:n}]}),await updateImsData(a,r,e,t,n,u,g)):"na"==d&&sugg.recent({meta_data:[{m_time:m,p_gid:d,p_vid:o,m:u}]})}else syncDataCalledCnt<5&&setTimeout(syncDataCheck,400);isSyncLSDataComplete=!0}function getDataFromCookies(e){let t,a=document.cookie||"";if(1==e){let r=a.match(/(glid%3D)[0-9]+/g);t=r?r[0].replace("glid%3D",""):void 0}else if(2==e){let n=a.match(/(_ga=GA1.2.)([0-9]+).([0-9]+)/g);t=n?n[0].replace("_ga=",""):void 0}else if(3==e){let i=a.match(/im_iss=t%3D[^( |;)]+/g);t=i?i[0].replace("im_iss=t%3D",""):void 0}else if(4==e){let c=a.match(/(dispid)[0-9]+/g);t=(t=c?c.toString():"")?t.replace(/dispid/g,""):""}return t}function deleteImsKey(e){"undefined"!=typeof asgv&&void 0!==asgv.store.setData&&asgv.store.setData("ims",e,[])}async function updateImsData(e,t,a,r,n,i,c){let l=window.location.hostname,s=l.includes("local")||l.includes("dev")||l.includes("stg")?"dev-":"",d=`https://${s}apps.imimg.com/index.php?r=Related/GetAttributes/&modid=MY&mode=${n}`,o,m=t&&"na"!==t,u=e&&"na"!==e,f=new Date().getTime();if(1==n&&m?o=d+`&gid=${t}&t=${f}`:2==n&&u&&m?o=d+`&glusrId=${e}&gid=${t}&t=${f}`:3==n&&u&&r&&"na"!==r&&(o=d+`&glusrId=${e}&AK=${r}&t=${f}`),o)try{let g=new AbortController,p=g.signal,y=setTimeout(()=>{g.abort()},3e3),h=await fetch(o,{method:"GET",signal:p});clearTimeout(y);let A=await h.json(),{code:E,categories:C=[],product:D=[],searches:I=[]}=A;Array.isArray(D)&&D.forEach(e=>{void 0===e.prod_url&&e.fl_name&&(e.prod_url=`https://www.indiamart.com/proddetail/${e.fl_name}.html`)});let M=[{m_time:new Date().getTime(),p_gid:e,p_vid:t,m:n}];function T(e){return e.sort((e,t)=>t.DT-e.DT),filterUniqueByKeys(e,"id")}async function P(e,t){(arr=T(t).slice(0,25)).length>0?await sugg.recent({[e]:arr}):deleteImsKey(e)}async function S(e,t,a){let r=a.concat(e);(r=T(r).slice(0,25))&&r.length>0?(r[0].type_update="s",await sugg.recent({[t]:r})):deleteImsKey(t)}async function w(e){Object.keys(e).forEach(async t=>{let a=await sugg.recent(`${t}`)||[];c&&(a=[]),200==E&&e[t]?.length>0?await S(e[t]||[],t,a):await P(t,a)})}sugg.recent({meta_data:M}),w({mcat_data:C,prod_data:D,keyw_data:I})}catch(v){console.log("Error: ",v),sendErrEvent("err",v,"updateImsData: ")}}function sendEvent(e,t,a,r){"undefined"!=typeof imgtm&&imgtm.push({event:"IMEvent-NI",eventCategory:e||"pers_log",eventAction:t||"",eventLabel:a||window.location.href,eventValue:r||""})}function sendErrEvent(e,t,a=""){sendEvent("err"===e?"pers_err":"pers_log",a+t.message,window.location.href,t.stack)}function trim_prod(e){let t=e.img_250||e.img_125||"";return""!=(t=(t=t.replace("http:","https:")).match(/(.*)default-image\/add-image.gif(.*)/)?"":t)&&""!=e.name}function trim_mcats(e){return(e.img_125||e.img_250||"")&&e.fl_name}function escapeHtmlKeywrd(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}function filterUniqueByKeys(e,t,a=""){let r=new Set;return e.filter(e=>{let n=String(e[t]),i=String(e[a]),c=a?`${n}_${i}`:n;return!r.has(c)&&r.add(c)})}function fetchUserCity(){let e="";try{let t=sessionStorage.getItem("minidtlsres")||"";if(t){let a=JSON.parse(t),r=Object.keys(a)[0],n=a[r]?.Response?.Data;n&&(e=n.user_city||"")}}catch(i){console.log("Error: ",i),sendErrEvent("err",i,"fetchUserCity: ")}return e}async function CheckSuggester(e){if("undefined"==typeof sugg||""==sugg||"function"!=typeof sugg.recent)return Promise.resolve();for(let t=0;t<10&&(!IMStore.localStorageLoaded||!isSyncLSDataComplete);t++)9===t&&sendEvent("pers_error","Exceeded retry limit for waiting for local storage",window.location.href,IMStore.localStorageLoaded),await new Promise(e=>setTimeout(e,500));try{let a=await e();return a}catch(r){return sendErrEvent("err",r,"CheckSuggester: "),[]}}!async function(){try{"complete"==document.readyState?setTimeout(()=>initFunc(1),200):$(window).load(function(){setTimeout(()=>initFunc(1),200)})}catch(e){console.log("Personalize.js error: ",e),sendErrEvent("err",e,"Global: ")}}();const keyMapProd={id:"DISPLAY_ID",img_250:"IMAGE_250X250",name:"ITEM_NAME",c_name:"COMPANYNAME",mcatid:"MCAT_ID",price_f:"PRICE_F",price_seo:"PRICE_SEO",c_url:"COMPANY_URL",d_flag:"IIL_DISPLAY_FLAG",iil_display_flag:"IIL_DISPLAY_FLAG",s_id:"GLUSR_ID",c_number:"CONTACT_NUMBER",c_w:"CUSTTYPE_WEIGHT",city:"CITY_NAME",img_125:"IMAGE_125X125",state:"STATE_NAME",v_url:"PROD_VIDEO_PATH",district:"DIST_NAME",tscode:"ETO_OFR_COMPANY_TSCODE",locality:"SDA_GLUSR_USR_LOCALITY",prod_url:"PDP_URL",fl_name:"GLCAT_MCAT_FLNAME",country:"GLUSR_USR_COUNTRYNAME",mcat_name:"GLCAT_MCAT_NAME",glusr_custname:"GLUSR_CUST_NAME",img_500x500:"IMAGE_500X500",ecom_flag:"SDA_IS_ECOM"},keyMapCatg={id:"GLCAT_MCAT_ID",img_125:"GLCAT_MCAT_IMG1_125X125",img_250:"GLCAT_MCAT_IMG1_250X250",name:"GLCAT_MCAT_NAME",fl_name:"GLCAT_MCAT_FLNAME",city:"",cityflname:""};function mapKeys(e,t){let a={};for(let[r,n]of Object.entries(t))a[r]=e[n]||"";return a}let sharedRelApiPromise=null;async function fetchSharedRelAPI(e){return sharedRelApiPromise||(sharedRelApiPromise=relatedApiFunc(e).then(e=>e).catch(e=>{sharedRelApiPromise=null,sendErrEvent("err",e,"fetchSharedRelAPI: ")})),sharedRelApiPromise}async function fetchPersProds(e){let t=e.count||0,a=e.modid||"",r=e.displayID||"",n=e.callRelatedAPI||!1,i=[],c=[],l=async()=>{c=await sugg.recent("mcat_data")||[],i=filterUniqueByKeys(i=await sugg.recent("prod_data")||[],"id").filter(trim_prod),c=filterUniqueByKeys(c,"id"),r&&(i=i.filter(e=>e&&e.id!=r));let e=i.length;try{if(t>e&&n){let l=c.length>0?c[0].id:"";if(l){let[s,d]=await fetchSharedRelAPI({modid:a,mcat_id:l}),o=s?.STATUS==200?s.RECOMMMENDATON_CATEGORY_BASED:[];if(!d&&o.length>0){let m=o.map(e=>mapKeys(e,keyMapProd));i.push(...m),i=filterUniqueByKeys(i,"id")}}}}catch(u){console.error("Error: ",u),sendErrEvent("err",u,"fetchPersProds relatedAPI: ")}return i};try{let s=await CheckSuggester(l);return s=s.slice(0,t)}catch(d){return console.error("Error in fetchFeaturedRecom: ",d),sendErrEvent("err",d,"fetchPersProds: "),[]}}async function fetchPersCatg(e){let t=e.count||0,a=e.modid||"",r=e.mcatID||"",n=e.callRelatedAPI||!1,i=[],c=async()=>{i=filterUniqueByKeys(i=await sugg.recent("mcat_data")||[],"id").filter(trim_mcats),r&&(i=i.filter(e=>e&&e.id!=r));let e=i.length;try{if(t>e&&n){let c=i.length>0?i[0].id:"";if(c){let[l,s]=await fetchSharedRelAPI({modid:a,mcat_id:c}),d=l?.STATUS==200?l.RECOMMENDATION_MCAT:[];if(!s&&d.length>0){let o=d.map(e=>mapKeys(e,keyMapCatg));i.push(...o),i=filterUniqueByKeys(i,"id")}}}}catch(m){console.error("Error: ",m),sendErrEvent("err",m,"fetchPersCatg relatedAPI: ")}let u=fetchUserCity()||"";u=tier1CityListPersonalize.includes(u)?u:"";for(let f=0;f<i.length;f++){u&&void 0!==i[f].cityflname&&!i[f].cityflname&&(i[f].city=u,i[f].cityflname=u.toLowerCase());let g=i[f].cityflname||"impcat";i[f].mcat_url=`https://dir.indiamart.com/${g}/${i[f].fl_name}.html`}return i};try{let l=await CheckSuggester(c);return l=l.slice(0,t)}catch(s){return sendErrEvent("err",s,"fetchPersCatg: "),[]}}async function relatedApiFunc(e){let{modid:t,mcat_id:a=""}=e;if(""==a)return[[],""];let r=window.location.hostname,n=`https://${r.includes("loc")||r.includes("dev")||r.includes("stg")?"dev-":""}apps.imimg.com/index.php?r=Related/RelatedAPIDATANew/&countP=15&countM=15&MOD=PERS&Modid=${t}&MCAT_ID=${a}&src=pers2`;try{let i=new AbortController,c=i.signal,l=setTimeout(()=>{i.abort()},3e3),s=await fetch(n,{method:"GET",signal:c});clearTimeout(l);let d=await s.json();return[d,""]}catch(o){return sendErrEvent("err",o,"relatedApiFunc: "),[[],o.message]}}function extractMcatsDetails(e){return 200==e.code&&Array.isArray(e.mcats)?e.mcats.map(e=>e.detail):[]}async function recomCatgFunc(e){let{count:t=0,modid:a,glid:r=""}=e,n=getDataFromCookies(3);r=r||getDataFromCookies(1);let i=window.location.hostname||"",c=`${i.includes("dev")||i.includes("stg")?"dev-":""}apps.imimg.com`;if(!n||!r)return[];let l=`https://${c}/index.php?r=Related/GetMcatRecomen/&glid=${r}&count=${t}&modid=${a}&type=1&AK=${n}`;try{let s=new AbortController,d=s.signal,o=setTimeout(()=>s.abort(),3e3),m=await fetch(l,{method:"GET",signal:d});clearTimeout(o);let u=await m.json();return u=extractMcatsDetails(u)}catch(f){return sendErrEvent("err",f,"recomCatgFunc: "),[]}}async function fetchPersSearches(e){let t=e.count||0,a=async()=>{let e=await sugg.recent("keyw_data")||[];return(e=filterUniqueByKeys(e,"id")).forEach(e=>{let t=escapeHtmlKeywrd(e.id);e.search_url=t?`https://dir.indiamart.com/search.mp?ss=${t}&src=rcv`:""}),e};try{let r=await CheckSuggester(a);return r=r.slice(0,t)}catch(n){return sendErrEvent("err",n,"fetchPersSearches: "),[]}}