// Current Version is 67
var _gaq = _gaq || [];
var webAddress=location.hostname;
var glid = '';
var Url_1 =webAddress.match(/^dev/)?"dev-":(webAddress.match(/^stg/))?"stg-":"";
var Url_2 =webAddress.match(/^dev/)?"stg-":(webAddress.match(/^stg/))?"stg-":"";
var minifiedOrNot = webAddress.match(/^dev/) ? 'im_msg.css' : 'im_msg.min.css';
$('<link rel="stylesheet" type="text/css" href="//'+Url_1+'utils.imimg.com/im_msg/css/' + minifiedOrNot + '?v=29" >').appendTo("head");
var msg_hit_click = 0, quick_reply_prsnt = 0;
function dropdown_messages() {
    event_ga_Track("HEADER_MSG_CTA", "CTA_click",glmodid);
    // body...
    // var v4iilex_cookie = readCookie("v4iilex");
    var im_iss_cookie = readCookie("im_iss");

    var ImeshVisitorcookie = readCookie("ImeshVisitor");
    const lgnstrcookie = readCookie("LGNSTR");
    const lgnstrArr = lgnstrcookie.split(',');
    var utype = getparamVal(ImeshVisitorcookie, "utyp");
    var iso = getparamVal(ImeshVisitorcookie, "iso");
    const nutype = lgnstrArr[1];
    const niso = lgnstrArr[7];
    if(utype == "" && nutype == 2 ){
        utype = "P";
    }else if(utype == "" && (nutype ==0 || nutype ==1) ){
        utype="F";
    }
    if(iso =="" && niso==0){
        iso="IN"
    }
    glid = getparamVal(ImeshVisitorcookie, "glid");
    if(im_iss_cookie != undefined && im_iss_cookie != "" && utype!= undefined && (utype == 'N' || utype == 'F')){
        if($('#ms_drop').html() != null){
            if($('#ms_drop').css('display') == 'block')
                $('#ms_drop').css("display","none");
            else{
                $('#ms_drop').css("display","block");
                event_yandex_Track('Messages_Widget_Click_Toggle_'+glmodid);
            }
        }
        if(msg_hit_click == 0){
            msg_hit_click = 1;
            //code to check the jwt
            var imiss_cookie = readCookie("im_iss");
            imiss_cookie = imiss_cookie.split('=')[1];
            var base64Url = imiss_cookie.split('.')[1];
            var jwt_base64 = decodeURIComponent(atob(base64Url).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            var tect = JSON.parse(jwt_base64);
            var exp_time = tect["exp"];
            var current_time = Date.now() / 1000;
            if(current_time > exp_time){
                event_ga_Track("HEADER_MSG_CTA", "cookie_expire",glmodid);
                event_yandex_Track('Messages_Widget_Display_Error_Expire_'+glmodid);
                window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
                return;
            }
            if(false){
                //new
                var chat_msg_ui = '<div class="chat_box" style="background: white;border-radius: 10px;width:340px;"><div class="chat_body" style="display:block;border-radius: 10px;"><div class="chat_user"><ul class="chat_message-user-name-section" id="chat_fetch_list"></div></div><a href="https://buyer.indiamart.com/enquiry/messagecentre/?src=1&modid=' + glmodid +'" style="display: flex;justify-content: center;background-color : rgb(0, 166, 153);width: 85%;border-radius: 10px;margin: 3% auto;font-size: 19px;font-weight: 600;padding: 12px;">View All Messages</a></div>';
            }else{
                //old
                var chat_msg_ui = '<div class="chat_box"><div class="chat_body" style="display:block"><div class="chat_user"><ul class="chat_message-user-name-section" id="chat_fetch_list"></div></div></div>';
            }
            $('#ms_drop').html(chat_msg_ui);
            $('#ms_drop').css("display","block");
            $(".chat_user").append('<div class="sk-fading-circle"><div class="sk-circle1 sk-circle"></div><div class="sk-circle2 sk-circle"></div><div class="sk-circle3 sk-circle"></div><div class="sk-circle4 sk-circle"></div><div class="sk-circle5 sk-circle"></div><div class="sk-circle6 sk-circle"></div><div class="sk-circle7 sk-circle"></div><div class="sk-circle8 sk-circle"></div><div class="sk-circle9 sk-circle"></div><div class="sk-circle10 sk-circle"></div><div class="sk-circle11 sk-circle"></div><div class="sk-circle12 sk-circle"></div></div>');
            contact_list();
        }
    } else if(im_iss_cookie != undefined && im_iss_cookie != "" && utype!= undefined && utype == 'P') {
        event_ga_Track("HEADER_MSG_CTA", "paid_user","full_login");
        window.location.href = "https://"+Url_1+"seller.indiamart.com/messagecentre";
    } else if(ImeshVisitorcookie != undefined && ImeshVisitorcookie != "" && utype!= undefined && (utype == 'N' || utype == 'F')) {
        if(iso == 'IN') {
            if($('#ms_drop').html() != null){
                if($('#ms_drop').css('display') == 'block'){
                    $('#ms_drop').css("display","none");
                    return;
                }
            }
            if( false){
                //new
                event_ga_Track("HEADER_MSG_CTA", "OTP_screen","new");
                var chat_login_ui = '<div class="chat_box" style="background: white;border-radius: 10px;width:340px;"><div class="chat_body" style="display:block;border-radius: 10px;"><div class="chat_user"><ul class="chat_message-user-name-section" id="chat_fetch_list"></div></div></div>';
            }else{
                //old
                event_ga_Track("HEADER_MSG_CTA", "OTP_screen","old");
                var chat_login_ui = '<div class="chat_box"><div class="chat_body" style="display:block"><div class="chat_user"><ul class="chat_message-user-name-section" id="chat_fetch_list"></div></div></div>';    
            }
            
            $('#ms_drop').html(chat_login_ui);
            $('#ms_drop').css("display","block");
            $(".chat_user").append('<div class="sk-fading-circle"><div class="sk-circle1 sk-circle"></div><div class="sk-circle2 sk-circle"></div><div class="sk-circle3 sk-circle"></div><div class="sk-circle4 sk-circle"></div><div class="sk-circle5 sk-circle"></div><div class="sk-circle6 sk-circle"></div><div class="sk-circle7 sk-circle"></div><div class="sk-circle8 sk-circle"></div><div class="sk-circle9 sk-circle"></div><div class="sk-circle10 sk-circle"></div><div class="sk-circle11 sk-circle"></div><div class="sk-circle12 sk-circle"></div></div>');
            if (typeof(isImloginV1Open) !== "undefined" && isImloginV1Open == 1) {
                fullLoginForm('','','','MSG_Head');
            } else {
                $.ajax({
                    url:"//"+UrlPri+"utils.imimg.com/header/scripts/login_services.php?modid=HEADERMSG",
                    success : function(response){
                             let loginArr = JSON.parse(response);
                             if(loginArr['imlogin']){
                                 $.getScript(loginArr['imlogin'], function(){signIn('','','','MSG_Head');});
                            }else{
                                $.getScript("//"+UrlPri+"utils.imimg.com/header/js/.foreign/imloginv1.js?v=43", function(){fullLoginForm('','','','MSG_Head');});
                             }
                    },
                    error:function(e){
                        console.log(e.msg);
                        event_ga_Track("HEADER_MSG_CTA", "OTP_screen","error");
                    }
                })
            }
            return false;
        } else {
            event_ga_Track("HEADER_MSG_CTA", "foreign_user",glmodid);
            window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
            return false;
        }
    } else if(ImeshVisitorcookie != undefined && ImeshVisitorcookie != "" && utype!= undefined && utype == 'P') {
        event_ga_Track("HEADER_MSG_CTA", "paid_user","half_login");
        window.location.href = "https://"+Url_1+"seller.indiamart.com/messagecentre";
        return false;
    }
    else{
        window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
    }
}
$('#lshead, #help-center').hover(function() {$('#ms_drop').css("display","none");});
$(document).mouseup(function (e){
    var container = $("#message-center");
    if (!container.is(e.target) && container.has(e.target).length === 0){
        $('#ms_drop').css("display","none");
    }
});
//******* GAtrack function ***************
function event_ga_Track(e, t, i, a, n) {
    if(typeof _gaq != "undefined"){
     _gaq.push(["_trackEvent", e, t, i, a, n]);    
    }
}
//******* Yandextrack function ***************
function event_yandex_Track(a) {
    if (typeof ym != 'function') {
        (function (b, o, j, n, h, g, f) {
            b[h] = b[h] || function () {
                (b[h].a = b[h].a || []).push(arguments)
            };
            b[h].l = 1 * new Date();
            g = o.createElement(j), f = o.getElementsByTagName(j)[0], g.async = 1, g.src = n, f.parentNode.insertBefore(g, f)
        })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
        ym(51115208, "init", {
            id: 51115208,
            clickmap: true,
            trackLinks: true,
            accurateTrackBounce: true,
            webvisor: true
        });
    }
    window.yaParams = {
        utils_track : a
    };
    ym(51115208, "params", window.yaParams || {});
}
// **********function for ajax hit to get the contact service data**********
function contact_list() {
    var ImeshVisitorcookie = readCookie("ImeshVisitor");
    var gl_val = getparamVal(ImeshVisitorcookie, "glid");
    var im_iss = readCookie("im_iss");
    var AK = getparamVal(im_iss, "t");
    // type 1 to find contact list for all -- type 0 to find contact on limit & offset
    var params = {'token' : "imobile@15061981",'glusrid' : gl_val,'start' : 1,'end' : 10,'type' : 0,'modid' : glmodid,'count' : 1,'AK' : AK};
    $.ajax({
        url : "https://"+Url_2+"utils.imimg.com/im_msg/js/im_msg_services.php",
        dataType : "json",
        type : "POST",
        crossDomain : true,
        data : params,
        success : function(response){
            if( false){
                //new
                contact_list_ui(response);
            }else{
                //old
                contact_list_ui_old(response);
            }
            
        },
        error : function (err) {
            console.log(err);
            event_ga_Track("HEADER_MSG_CTA", "list_api_error","error_contact_list");
            window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
        }
    });
    return false;
}
//*****************function to redirect the user to message centre*************
function get_id(contact_glid,buyer_name,type, new_or_old) {
    event_ga_Track("HEADER_MSG_CTA", "contact_click",new_or_old);
    var url = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?msg_widget=1&sup_glid="+btoa(contact_glid)+"&sup_type="+type+"&src=1&modid="+glmodid;
    var win = window.open(url,'_blank');
    event_yandex_Track('Messages_Widget_Click_Contact_'+glmodid);
}

function ga_redirect(val) {
    // body...
    if(val==1){
        event_ga_Track('Messages_Widget','Click_Error_Expire',glmodid,0,0);
        var url = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
        var win = window.open(url,'_blank');
    }
    if(val==2){
        var url = "https://"+Url_1+"buyer.indiamart.com/buyertools/postbl/";
        var win = window.open(url,'_blank');
    }
}


// *********to read data from cookie*************
function readCookie(name){
    var search = name + "=";
    if (document.cookie.length > 0){ 
        offset = document.cookie.indexOf(search)
        if (offset != -1) // if cookie exists
        { 
            offset += search.length
            end = document.cookie.indexOf(";", offset)  // set index of beginning of value
            if (end == -1) end = document.cookie.length // set index of end of cookie value
            return unescape(document.cookie.substring(offset, end));
        }
    }
    if (name == 'v4iilex'){ return readCookie('v4iil'); }
    return "";
}
function getparamVal(cookieStr, key){
    if( cookieStr > "") {
        var val = "|"+cookieStr+"|";
        var pattern = new RegExp(".*?\\|"+key+"=([^|]*).*|.*");
        return val.replace(pattern, "$1");
    }
    else {  return ""; }
}
//**********function to create the ui of contact list
function contact_list_ui(response){
    var resultlist = response.Response;
    if(resultlist != undefined && resultlist?.Data?.code == 200) {
        var stat = resultlist.Data.Status;
        var message = resultlist.Data.message;
        var stat1 = resultlist.Data.STATUS;
        var Code1 = resultlist.Data.CODE;
        var stat2 = resultlist.Data.status;
        var count2 = resultlist.Data.count;
        var Code2 = resultlist.Data.code;
        var result_arr = resultlist.Data.result;
    } else {
        var stat1 = resultlist.Status;
        var Code1 = resultlist.Code;
    }
    if(stat == 401 && message.match("No service Available")){
        event_ga_Track('Messages_Widget_new','Display_Error_Service',glmodid,0,1);
        window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
        return false;
    }
    if(stat1 == "FAILURE" && (Code1 == 400 || Code1 == 401 || Code1 == 402 || Code1 == 403)){
        event_ga_Track('Messages_Widget_new','Display_Error_Token',glmodid,0,1);
        window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
        return false;
    }
    if(Code1 == 204 && stat1.toUpperCase() == "FAILURE"){
        event_ga_Track('Messages_Widget_new','Display_Error_Failure',glmodid,0,1);
        window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
        return false;
    }
    if(Code2 == 204 && stat2 == "failure" && message.match("No AddressList Found")){
        setTimeout(function(){ 
            $('.sk-fading-circle').css("display","none");
            if($('.chat_message-user-name-section').length == 0){
                $(".chat_user").html('<ul class="chat_message-user-name-section" id="chat_fetch_list">');
            }
            $(".chat_message-user-name-section").html('<div style="text-align: center;margin: 25px 40px;"><img class="arr1" id="msg_ico" style="padding-botton: 10px;width:37px;height:34px;margin-bottom: 5px;" src="//utils.imimg.com/im_msg/image/speech-bubble.svg"><span id="not_working" style="color: #666666;font-size: 12px;line-height: 16px;">You have no Messages.</span><div style="margin: 10px -42px 0px -44px;color: #000000;font-size: 12px;line-height: 18px;"><span id="not_working_post_link">Kindly tell us your requirement to receive quotes from sellers.</span><button class="no_cntct_post_req" onclick="ga_redirect(2);">Post Requirement</button></div></div>');
        }, 500);
        return false;
    }
    if(Code2 == 200 && stat2 == "success") {
        if(count2 == 0) {
            event_ga_Track("HEADER_MSG_CTA", "imp_empty_list","new");
            $(".chat_message-user-name-section").html('<div style="text-align: center;margin: 25px 40px;"><img class="arr1" id="msg_ico" style="padding-botton: 10px;width:37px;height:34px;margin-bottom: 5px;" src="//utils.imimg.com/im_msg/image/speech-bubble.svg"><span id="not_working" style="color: #666666;font-size: 12px;line-height: 16px;">You have no Messages.</span><div style="margin: 15px -42px 0px -44px;color: #000000;font-size: 12px;line-height: 17px;"><span id="not_working_post_link">Kindly tell us your requirement to receive quotes from verified suppliers.</span><button class="no_cntct_post_req" onclick="ga_redirect(2);">Get Quotes</button></div></div>');
            return false;
        }
        event_ga_Track("HEADER_MSG_CTA", "imp","new");
        var html = '<input type="hidden" id="count_contact" value="'+count2+'">';
        for (var i = 0; i < result_arr.length; i++) {
            var c = result_arr[i];
            var c_name          = c.contacts_name          === undefined || c.contacts_name          === null || c.contacts_name          === '' ? 'Buyer' : htmlEscape(c.contacts_name);
            c_name              = c_name.charAt(0).toUpperCase() + c_name.slice(1);
            var c_company       = c.contacts_company       === undefined || c.contacts_company       === null || c.contacts_company       === '' ? ''      : htmlEscape(c.contacts_company);
            var c_mobile        = c.contacts_mobile1       === undefined || c.contacts_mobile1       === null || c.contacts_mobile1       === '' ? ''      : htmlEscape(c.contacts_mobile1);
            var contacts_glid   = c.contacts_glid          === undefined || c.contacts_glid          === null || c.contacts_glid          === '' ? ''      : c.contacts_glid;
            var contacts_type   = c.contacts_type          === undefined || c.contacts_type          === null || c.contacts_type          === '' ? ''      : c.contacts_type;
            var c_country       = c.country_name           === undefined || c.country_name           === null || c.country_name           === '' ? ''      : htmlEscape(c.country_name);
            var c_state         = c.contact_state          === undefined || c.contact_state          === null || c.contact_state          === '' ? ''      : c.contact_state;
            var c_city          = c.contact_city           === undefined || c.contact_city           === null || c.contact_city           === '' ? ''      : htmlEscape(c.contact_city);
            var unrd_msg_cnt    = c.unread_message_cnt     === undefined || c.unread_message_cnt     === null || c.unread_message_cnt     === '' ? ''      : c.unread_message_cnt;
            var product         = c.contact_last_product   === undefined || c.contact_last_product   === null || c.contact_last_product   === '' ? ''      : c.contact_last_product;
            var last_message    = c.last_message           === undefined || c.last_message           === null || c.last_message           === '' ? ''      : c.last_message;
            var last_msg = last_message;
            var ast_msg_cnct = '';
            last_message        = last_message.replace('<', '&lt;');
            last_message        = last_message.replace('>', '&gt;');
            last_message        = last_message.length > 40 ? last_message.substr(0, 40) + "..." : last_message;
            if(c_name != '' || c_mobile != '') {
                html = html + '<li class="chat_user_name1" id ="'+contacts_glid+'"><a onclick = "get_id('+contacts_glid+',\''+c_name+'\','+contacts_type+',\'new\');" style="display: flex;flex-direction: column;align-items: flex-start;gap: 3px;padding-top: 6px;padding-left: 6px;padding-bottom: 5px;">';
                var addr_display = '';
                if(c_country != '' && c_country.toLowerCase() != 'india'){
                    addr_display = '<c_state></c_state><c_country>' + c_country + '</c_country>';
                } else {
                    addr_display = '<c_state></c_state><c_country></c_country>';
                }
                if(c_city != ''){
                    if(c_state != '')
                        addr_display = '<c_city>' + c_city + '</c_city>' + addr_display;
                    else
                        addr_display = '<c_city>' + c_city + '</c_city>' + addr_display;
                } else {
                    addr_display = '<c_city></c_city>' + addr_display;
                }
                var disp_company     = c_company != '' ? ' <c_company>' + c_company + '</c_company>' : '<c_company></c_company>';
                var coma = '';
                if(c_company != '' && (c_city != '' || (c_country != '' && c_country.toLowerCase() != 'india')))
                    coma = ', ';
                if(c_company != ''){
                    html = html + '<p class="chat_c_addr chat_wrd_elip" style="font-weight: 600;font-size: 14px;">' + disp_company + coma + addr_display + '</p>';
                }
                if(c_company != '' && ( c_city != ''  || (c_country != '' && c_country.toLowerCase() != 'india')) )
                    // html = html + '<br>';
                var add_bold_cls = '';
                if(c_company == ''){
                    add_bold_cls ='font-weight: 600;font-size: 14px;';
                    html = html + '<p id="c_name" style="'+add_bold_cls+'">'+c_name+'</p>';
                }
                var lst_snpt_cls = 'chat_last-msg-snippet';
                if(product != ''){

                    html = html + '<p class="clr chat_wrd_elip chat_prod-p-cls" style="font-weight: 600;font-size: 15px;display: flex;gap: 4px;align-items: center;"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="12" viewBox="0 0 14 14" fill="none"><g clip-path="url(#clip0_2755_6293)"><path d="M5.24935 12.8307C5.57152 12.8307 5.83268 12.5696 5.83268 12.2474C5.83268 11.9252 5.57152 11.6641 5.24935 11.6641C4.92718 11.6641 4.66602 11.9252 4.66602 12.2474C4.66602 12.5696 4.92718 12.8307 5.24935 12.8307Z" stroke="#686868" stroke-linecap="round" stroke-linejoin="round"></path><path d="M11.6673 12.8307C11.9895 12.8307 12.2507 12.5696 12.2507 12.2474C12.2507 11.9252 11.9895 11.6641 11.6673 11.6641C11.3452 11.6641 11.084 11.9252 11.084 12.2474C11.084 12.5696 11.3452 12.8307 11.6673 12.8307Z" stroke="#686868" stroke-linecap="round" stroke-linejoin="round"></path><path d="M0.583984 0.585938H2.91732L4.48065 8.39677C4.53399 8.66534 4.6801 8.90658 4.89339 9.07828C5.10667 9.24998 5.37356 9.34118 5.64732 9.33594H11.3173C11.5911 9.34118 11.858 9.24998 12.0712 9.07828C12.2845 8.90658 12.4306 8.66534 12.484 8.39677L13.4173 3.5026H3.50065" stroke="#686868" stroke-linecap="round" stroke-linejoin="round"></path></g><defs><clipPath id="clip0_2755_6293"><rect width="14" height="14" fill="white"></rect></clipPath></defs></svg><span class="chat_prdct_dsply" style="color: #686868;font-weight: 400;font-size: 12px;width:85%;text-overflow: ellipsis;overflow: hidden;">'+product+'</span></p>';
                } else {
                    html = html + '</div><p class="clr wrd_elip"></p>';
                    lst_snpt_cls = 'chat_no-prdct-snippet';
                }
                var ext_1 = '',ext_2 = '';
                // if(last_msg == 'IndiaMART connected you with this seller' || last_msg == 'You have sent an enquiry to this seller' || last_msg.substring(0,18) == "I am searching for" || last_msg.substring(0,18) == "I am interested in" || last_msg.substring(0,6) == "I need" || last_msg.substring(0,13) == "I want to buy" || last_msg.substring(0,18) == "I want to purchase"){
                //     ext_1 = "Say Hi";
                //     ext_2 = "Request Call Back";
                // } else if(last_msg == 'Waiting for your reply') {
                //     if(unrd_msg_cnt!="" && unrd_msg_cnt > 0){
                //     ext_1 = "Follow-up";
                //         ext_2 = "Request Call Back";
                //     } else {
                //         ext_1 = "Say Hi";
                //         ext_2 = "Request Call Back";
                //     }
                // } else if(last_msg == "Thank you for showing interest in our products and contactin" ) {
                //     if(unrd_msg_cnt!="" && unrd_msg_cnt > 0){
                //     ext_1 = "Say Thanks";
                //         ext_2 = "Request photos";
                //     } else {
                //         ext_1 = "Follow-up";
                //         ext_2 = "Request Call Back";
                //     }
                // } else if(last_msg == 'Call attempted - incoming') {
                //     ext_1 = "Follow-Up";
                //     ext_2 = "Request Call Back";
                // } else if(last_msg == 'Please find the Attachment') {
                //     if(unrd_msg_cnt!="" && unrd_msg_cnt > 0){
                //         ext_1 = "Say Thanks";
                //         ext_2 = "Request Catalog";
                //     } else {
                //         ext_1 = "Follow-up";
                //         ext_2 = "Request Call Back";
                //     }
                // } else {
                //     if(unrd_msg_cnt!="" && unrd_msg_cnt > 0){
                //         ext_1 = "Ok Thanks";
                //         ext_2 = "Please Call";
                //     }
                // }
                var reply_orint_class = '';
                if(ext_1 != '' && ext_2 != '')
                    reply_orint_class = 'reply_orint_class';
                html = html + '<p class="'+lst_snpt_cls+'chat_wrd_elip last_msg '+ast_msg_cnct+'" style="font-size: 13px;color: #000;padding-left: 3px;margin-top: 2px !important;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">';
                html = html + ''+last_message+'</p>';
                // html = html + '<p class="clr wrd_elip chat_rep-p-cls '+reply_orint_class+'"></p>';  
                if(unrd_msg_cnt !='' && unrd_msg_cnt > 0)
                    html = html + '<span id="'+contacts_glid+'" style="bottom:10px;left:300px;" class="chat_msg_unrd_cnt">'+unrd_msg_cnt+'</span>';
                html = html + '</a>';
                // if(false) {
                //     html += '<span class="inst_rep_msg" style="width:85%"><span class="inst_rep_msg_btn" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;" onclick="msg_reply_drop_down(\''+ext_1+'\',\''+contacts_glid+'\',\''+c_name+'\',\''+product+'\',\''+i+'\');">'+ext_1+'</span><span class="inst_rep_msg_btn" style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;" onclick="msg_reply_drop_down(\''+ext_2+'\',\''+contacts_glid+'\',\''+c_name+'\',\''+product+'\',\''+i+'\');">'+ext_2+'</span></span>';
                //     quick_reply_prsnt = 1;
                // }
                html = html + '</li>';
            }
        }
        if($('.chat_message-user-name-section').length == 0) {
            $(".chat_user").html('<ul class="chat_message-user-name-section" id="chat_fetch_list">');
        }
        $('.sk-fading-circle').css("display","none");
        $(".chat_message-user-name-section").html(html);
    }
}

function contact_list_ui_old(response){
    var resultlist = response.Response;
    if(resultlist != undefined && resultlist?.Data?.code == 200) {
        var stat = resultlist.Data.Status;
        var message = resultlist.Data.message;
        var stat1 = resultlist.Data.STATUS;
        var Code1 = resultlist.Data.CODE;
        var stat2 = resultlist.Data.status;
        var count2 = resultlist.Data.count;
        var Code2 = resultlist.Data.code;
        var result_arr = resultlist.Data.result;
    } else {
        var stat1 = resultlist.Status;
        var Code1 = resultlist.Code;
    }
    if(stat == 401 && message.match("No service Available")){
        event_ga_Track('Messages_Widget','Display_Error_Service',glmodid,0,1);
        window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
        return false;
    }
    if(stat1 == "FAILURE" && (Code1 == 400 || Code1 == 401 || Code1 == 402 || Code1 == 403)){
        event_ga_Track('Messages_Widget','Display_Error_Token',glmodid,0,1);
        window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
        return false;
    }
    if(Code1 == 204 && stat1.toUpperCase() == "FAILURE"){
        event_ga_Track('Messages_Widget','Display_Error_Failure',glmodid,0,1);
        window.location.href = "https://"+Url_1+"buyer.indiamart.com/enquiry/messagecentre/?src=1&modid="+glmodid;
        return false;
    }
    if(Code2 == 204 && stat2 == "failure" && message.match("No AddressList Found")){
        setTimeout(function(){ 
            $('.sk-fading-circle').css("display","none");
            if($('.chat_message-user-name-section').length == 0){
                $(".chat_user").html('<ul class="chat_message-user-name-section" id="chat_fetch_list">');
            }
            $(".chat_message-user-name-section").html('<div style="text-align: center;margin: 25px 40px;"><img class="arr1" id="msg_ico" style="padding-botton: 10px;width:37px;height:34px;margin-bottom: 5px;" src="//utils.imimg.com/im_msg/image/speech-bubble.svg"><br><span id="not_working" style="color: #666666;font-size: 12px;line-height: 16px;">You have no Messages.</span><br><div style="margin: 10px -42px 0px -44px;color: #000000;font-size: 12px;line-height: 18px;"><span id="not_working_post_link">Kindly tell us your requirement to receive quotes from sellers.</span><br><button class="no_cntct_post_req" onclick="ga_redirect(2);">Post Requirement</button></div></div>');
        }, 500);
        return false;
    }
    if(Code2 == 200 && stat2 == "success") {
        if(count2 == 0) {
            event_ga_Track("HEADER_MSG_CTA", "imp_empty_list","old");
            $(".chat_message-user-name-section").html('<div style="text-align: center;margin: 25px 40px;"><img class="arr1" id="msg_ico" style="padding-botton: 10px;width:37px;height:34px;margin-bottom: 5px;" src="//utils.imimg.com/im_msg/image/speech-bubble.svg"><br><span id="not_working" style="color: #666666;font-size: 12px;line-height: 16px;">You have no Messages.</span><br><div style="margin: 15px -42px 0px -44px;color: #000000;font-size: 12px;line-height: 17px;"><span id="not_working_post_link">Kindly tell us your requirement to receive quotes from verified suppliers.</span><br><button class="no_cntct_post_req" onclick="ga_redirect(2);">Get Quotes</button></div></div>');
            return false;
        }
        event_ga_Track("HEADER_MSG_CTA", "imp","old");
        var html = '<input type="hidden" id="count_contact" value="'+count2+'">';
        for (var i = 0; i < result_arr.length; i++) {
            var c = result_arr[i];
            var c_name          = c.contacts_name          === undefined || c.contacts_name          === null || c.contacts_name          === '' ? 'Buyer' : htmlEscape(c.contacts_name);
            c_name              = c_name.charAt(0).toUpperCase() + c_name.slice(1);
            var c_company       = c.contacts_company       === undefined || c.contacts_company       === null || c.contacts_company       === '' ? ''      : htmlEscape(c.contacts_company);
            var c_mobile        = c.contacts_mobile1       === undefined || c.contacts_mobile1       === null || c.contacts_mobile1       === '' ? ''      : htmlEscape(c.contacts_mobile1);
            var contacts_glid   = c.contacts_glid          === undefined || c.contacts_glid          === null || c.contacts_glid          === '' ? ''      : c.contacts_glid;
            var contacts_type   = c.contacts_type          === undefined || c.contacts_type          === null || c.contacts_type          === '' ? ''      : c.contacts_type;
            var c_country       = c.country_name           === undefined || c.country_name           === null || c.country_name           === '' ? ''      : htmlEscape(c.country_name);
            var c_state         = c.contact_state          === undefined || c.contact_state          === null || c.contact_state          === '' ? ''      : c.contact_state;
            var c_city          = c.contact_city           === undefined || c.contact_city           === null || c.contact_city           === '' ? ''      : htmlEscape(c.contact_city);
            var unrd_msg_cnt    = c.unread_message_cnt     === undefined || c.unread_message_cnt     === null || c.unread_message_cnt     === '' ? ''      : c.unread_message_cnt;
            var product         = c.contact_last_product   === undefined || c.contact_last_product   === null || c.contact_last_product   === '' ? ''      : c.contact_last_product;
            var last_message    = c.last_message           === undefined || c.last_message           === null || c.last_message           === '' ? ''      : c.last_message;
            var last_msg = last_message;
            var ast_msg_cnct = '';
            last_message        = last_message.replace('<', '&lt;');
            last_message        = last_message.replace('>', '&gt;');
            last_message        = last_message.length > 40 ? last_message.substr(0, 40) + "..." : last_message;
            if(c_name != '' || c_mobile != '') {
                html = html + '<li class="chat_user_name1" id ="'+contacts_glid+'"><a onclick = "get_id('+contacts_glid+',\''+c_name+'\','+contacts_type+',\'old\');">';
                var addr_display = '';
                if(c_country != '' && c_country.toLowerCase() != 'india'){
                    addr_display = '<c_state></c_state><c_country>' + c_country + '</c_country>';
                } else {
                    addr_display = '<c_state></c_state><c_country></c_country>';
                }
                if(c_city != ''){
                    if(c_state != '')
                        addr_display = '<c_city>' + c_city + '</c_city>' + addr_display;
                    else
                        addr_display = '<c_city>' + c_city + '</c_city>' + addr_display;
                } else {
                    addr_display = '<c_city></c_city>' + addr_display;
                }
                var disp_company     = c_company != '' ? ' <c_company>' + c_company + '</c_company>' : '<c_company></c_company>';
                var coma = '';
                if(c_company != '' && (c_city != '' || (c_country != '' && c_country.toLowerCase() != 'india')))
                    coma = ', ';
                if(c_company != ''){
                    html = html + '<p class="chat_c_addr chat_wrd_elip">' + disp_company + coma + addr_display + '</p>';
                }
                if(c_company != '' && ( c_city != ''  || (c_country != '' && c_country.toLowerCase() != 'india')) )
                    html = html + '<br>';
                var add_bold_cls = '';
                if(c_company == ''){
                    add_bold_cls ='font-size:14px; line-height:16px;color: #000000;';
                    html = html + '<p id="c_name" style="'+add_bold_cls+'">'+c_name+'</p>';
                }
                var lst_snpt_cls = 'chat_last-msg-snippet';
                if(product != ''){
                    html = html + '<p class="clr chat_wrd_elip chat_prod-p-cls"><span class="chat_prd_icn_grey"></span><span class="chat_prdct_dsply">'+product+'</span></p>';
                } else {
                    html = html + '</div><p class="clr wrd_elip"></p>';
                    lst_snpt_cls = 'chat_no-prdct-snippet';
                }
                var ext_1 = '',ext_2 = '';
                if(last_msg == 'IndiaMART connected you with this seller' || last_msg == 'You have sent an enquiry to this seller' || last_msg.substring(0,18) == "I am searching for" || last_msg.substring(0,18) == "I am interested in" || last_msg.substring(0,6) == "I need" || last_msg.substring(0,13) == "I want to buy" || last_msg.substring(0,18) == "I want to purchase"){
                    ext_1 = "Say Hi";
                    ext_2 = "Request Call Back";
                } else if(last_msg == 'Waiting for your reply') {
                    if(unrd_msg_cnt!="" && unrd_msg_cnt > 0){
                    ext_1 = "Follow-up";
                        ext_2 = "Request Call Back";
                    } else {
                        ext_1 = "Say Hi";
                        ext_2 = "Request Call Back";
                    }
                } else if(last_msg == "Thank you for showing interest in our products and contactin" ) {
                    if(unrd_msg_cnt!="" && unrd_msg_cnt > 0){
                    ext_1 = "Say Thanks";
                        ext_2 = "Request photos";
                    } else {
                        ext_1 = "Follow-up";
                        ext_2 = "Request Call Back";
                    }
                } else if(last_msg == 'Call attempted - incoming') {
                    ext_1 = "Follow-Up";
                    ext_2 = "Request Call Back";
                } else if(last_msg == 'Please find the Attachment') {
                    if(unrd_msg_cnt!="" && unrd_msg_cnt > 0){
                        ext_1 = "Say Thanks";
                        ext_2 = "Request Catalog";
                    } else {
                        ext_1 = "Follow-up";
                        ext_2 = "Request Call Back";
                    }
                } else {
                    if(unrd_msg_cnt!="" && unrd_msg_cnt > 0){
                        ext_1 = "Ok Thanks";
                        ext_2 = "Please Call";
                    }
                }
                var reply_orint_class = '';
                if(ext_1 != '' && ext_2 != '')
                    reply_orint_class = 'reply_orint_class';
                html = html + '<p class="'+lst_snpt_cls+'chat_wrd_elip last_msg '+ast_msg_cnct+'">';
                html = html + ''+last_message+'</p>';
                html = html + '<p class="clr wrd_elip chat_rep-p-cls '+reply_orint_class+'"><span class="chat_rep_icn"></span><span class="chat_rep_dsply" >Reply</span></p>';  
                if(unrd_msg_cnt !='' && unrd_msg_cnt > 0)
                    html = html + '<span id="'+contacts_glid+'" class="chat_msg_unrd_cnt">'+unrd_msg_cnt+'</span>';
                html = html + '</a>';
                if(ext_1 != '' && ext_2 != '') {
                    html += '<span class="inst_rep_msg"><span class="inst_rep_msg_btn" onclick="msg_reply_drop_down(\''+ext_1+'\',\''+contacts_glid+'\',\''+c_name+'\',\''+product+'\',\''+i+'\');">'+ext_1+'</span><span class="inst_rep_msg_btn" onclick="msg_reply_drop_down(\''+ext_2+'\',\''+contacts_glid+'\',\''+c_name+'\',\''+product+'\',\''+i+'\');">'+ext_2+'</span></span>';
                    quick_reply_prsnt = 1;
                }
                html = html + '</li>';
            }
        }
        if($('.chat_message-user-name-section').length == 0) {
            $(".chat_user").html('<ul class="chat_message-user-name-section" id="chat_fetch_list">');
        }
        $('.sk-fading-circle').css("display","none");
        $(".chat_message-user-name-section").html(html);
    }
}

//**** to remove the html script tags ********
function htmlEscape(string) {
    var htmlEscapes = {'<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#x27;','/': '&#x2F;'};
    var htmlEscaper = /[<>"'\/]/g;
    return ('' + string).replace(htmlEscaper, function(match) {
        return htmlEscapes[match];
    });
}; 

/*Function to send the reply instantly to seller with Ajax request*/
function msg_reply_drop_down(ext_val,recv_id,rec_name,rec_prod,clk_pos) {
    // body...
    var msg_send = '', recv_name = '', recv_prod = '';
    var ImeshVisitorcookie = readCookie("ImeshVisitor");
    if(rec_name != '' && rec_name != 'Buyer')
      recv_name = rec_name;
    if(ext_val == "Follow-Up") {
      msg_send = 'Hi '+recv_name+', Thanks for talking to me.Looking forward to do business with you.';
    } else if(ext_val == "Follow-up") {
      msg_send = 'Hi '+recv_name+', Looking forward to doing business with you.';
    } else if(ext_val == "Request Call Back") {
          var mb_val = getparamVal(ImeshVisitorcookie, "mb1");
          var em_val = getparamVal(ImeshVisitorcookie, "em");
          var phcc_val = getparamVal(ImeshVisitorcookie, "phcc");
          if(phcc_val == 91)
        msg_send = 'Hi '+recv_name+', Please Contact me at '+mb_val;
      else
        msg_send = 'Hi '+recv_name+', Please Contact me at '+em_val;
    } else if(ext_val == "Say Hi") {
      msg_send = 'Hi '+recv_name;
    } else if(ext_val == "Say Thanks") {
      msg_send = 'Thank you';
    } else if(ext_val == "Ok Thanks") {
      msg_send = 'Ok Thanks';
    } else if(ext_val == "Request photos") {
        msg_send = 'Request product photos';
    } else if(ext_val == "Please Call") {
          var mb_val = getparamVal(ImeshVisitorcookie, "mb1");
          var em_val = getparamVal(ImeshVisitorcookie, "em");
          var phcc_val = getparamVal(ImeshVisitorcookie, "phcc");
          if(phcc_val == 91)
        msg_send = 'Hi '+recv_name+', Please Contact me at '+mb_val;
      else
        msg_send = 'Hi '+recv_name+', Please Contact me at '+em_val;
    } else if(ext_val == "Request Product photos") {
      msg_send = 'Kindly send more photos of this product.';
    } else if(ext_val == "Request Catalog") {
      msg_send = 'Kindly send me your catalog.';
    }
    var glid = getparamVal(ImeshVisitorcookie, "glid");
    var im_iss = readCookie("im_iss");
    var AK = getparamVal(im_iss, "t");
      if(rec_prod != '' || rec_prod != null)
        recv_prod = rec_prod;
  
    var data_param  =   {
        'type'              : 'sendReply',
        'modid'             : glmodid,
        'subject'           : 'Message Centre Header Widget',
        'msg'               : msg_send,
        'qid'               : 1,
        'recv_id'           : recv_id,
        'IIL_RFQ_SOURCE_ID' : 35,
        'qtype'             : 'C',
        'attachments'       : '',
        'glid'              : glid,
        'ETO_OFR_ID'        : '',
        'ETO_OFR_TITLE'     : recv_prod,
        'AK'                : AK,
        'dir_query_reply_template_flag' : 41
        };
    $.ajax({
        url         : '/' + homeServerName + 'header/scripts/head_services.php',
        data        :  data_param,
        dataType    : "json",
        type        : "GET",
        success: function(result) { 
            try{
                if(result['code'] == 200 && result['RESP'] == "success"){
                    $('#'+recv_id+' .last_msg').html(msg_send);
                    $('#'+recv_id+' .inst_rep_msg').css("display","none");
                    $('#'+recv_id+' .chat_msg_unrd_cnt').css("display","none");
                    $('#'+recv_id+' .last_msg').removeClass('ast_msg_cnct');
                    $('#'+recv_id+' .chat_rep-p-cls').removeClass('reply_orint_class');
                }
            }
            catch(err){
                console.log("error while sending message");
            }
        }
    }); 
}
